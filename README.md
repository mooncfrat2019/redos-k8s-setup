# Плейбуки для установки кластера k8s на Ред ОС 7.3 (в изолированно среде air-grapped)
(также возможна установка на Ред ОС 8)

Содержимое:
- Скрипты для сборки образов зависимостей
- Файлы (образ images (registry:latest), binares (cilium, cni, crictl, k8s))
- Плейбуки (роли для отдельных шагов)

## Перед тем как начать
Убедитесь, что у вас есть 4 ВМ с Ред ОС (одна для registry, три остальных для нод)
Также нужно зеркало до репозитория Ред ОС

Версия k8s 1.33.4 (устанавливается не из пакетного менеджера, так как на текущий момент он очень старая в репозитори)
Установка компонентов кубернетеса происходит путем копирования бинарников в папку /usr/bin и в некоторых случаях ручном создании systemd сервисов

## Установка
Установку можно разделить по тегам и этапам:
1) На машине с доступом в интернет запускаются скрипты (prepare-offline-content.sh)

В этот момент запускаются связанные скрипты для скачивания и сохранения образов.
Чтобы команда отработала корректно нужно заранее узнать IP адрес registry сервера.
Скрипт нужно вызывать вот так ```./scripts/prepare-offline-content.sh <REGISTRY_SERVER_IP>:5000```
Предварительно нужно сделать файлы скриптов исполняемыми.

2) transfer // выполняет копирование бандла на хосты (стоит запускать с --limit registry-server)
3) common // запускает подготовку ВМ
4) docker-registry // производит установку docker registry (нужен чтобы k8s мог скачивать образы оттуда)
5) etcd // установка кластера etcd на те же ноды (master-node) с кворумом 3
6) kubernetes // выполняет установку и настройку кластера k8s

Пример комады запуска:
```shell

ansible-playbook -i inventory/hosts.yml main.yml -e '{
  "super_user": "redos",
  "host_1": "200.200.199.199",
  "host_2": "200.200.199.200",
  "host_3": "200.200.199.201",
  "in_ip_1": "10.0.3.9",
  "in_ip_2": "10.0.3.8",
  "in_ip_3": "10.0.3.7",
  "host_registry": "200.200.199.202",
  "pod_network_cidr": "10.244.0.0/16",
  "cni_plugin": "flannel",
  "skip_bundle_transfer": false,
  "need_restart": true,
  "need_k8s_prepare": true
}' --tags transfer --limit registry-server
```
Здесь можно заметить:
-`cni_plugin` -- определяет какой плагин нужно использовать
- need_restart -- нужен ли рестарт серверов после выполнения common
- need_k8s_prepare -- нужны ли подготовительные шаги в роли kubernetes
- skip_bundle_transfer -- нужно ли пропустить трасфер бандла
